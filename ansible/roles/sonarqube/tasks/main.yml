
---
- name: Create SonarQube directory
  file:
    path: /opt/sonarqube
    state: directory
    mode: '0755'

- name: Drop sonar.properties
  copy:
    src: files/sonar.properties
    dest: /opt/sonarqube/sonar.properties
    mode: '0644'

- name: Create docker-compose.yml for SonarQube
  copy:
    dest: /opt/sonarqube/docker-compose.yml
    mode: '0644'
    content: |
      version: "3.9"
      services:
        db:
          image: postgres:13
          environment:
            POSTGRES_USER: sonar
            POSTGRES_PASSWORD: sonar
            POSTGRES_DB: sonarqube
          volumes:
            - db_data:/var/lib/postgresql/data
        sonarqube:
          image: sonarqube:community
          depends_on:
            - db
          ports:
            - "9000:9000"
          environment:
            - SONAR_JDBC_URL=jdbc:postgresql://db:5432/sonarqube
            - SONAR_JDBC_USERNAME=sonar
            - SONAR_JDBC_PASSWORD=sonar
          volumes:
            - sonar_data:/opt/sonarqube/data
            - sonar_logs:/opt/sonarqube/logs
            - sonar_extensions:/opt/sonarqube/extensions
            - /opt/sonarqube/sonar.properties:/opt/sonarqube/conf/sonar.properties
      volumes:
        db_data:
        sonar_data:
        sonar_logs:
        sonar_extensions:

- name: Start SonarQube
  shell: |
    cd /opt/sonarqube
    docker compose up -d
  args:
    executable: /bin/bash
